<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Berry AnimationEngine Test</title>
    <style>
        body {
            background-color: #252525;
            color: #d0d0d0;
            font-family: verdana, sans-serif;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #4f4f4f;
            border-radius: 5px;
        }
        h1, h2 {
            color: #1fa3ec;
        }
        canvas {
            border: 1px solid #666;
            display: block;
            margin: 10px 0;
        }
        button {
            background-color: #1fa3ec;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0d8bd9;
        }
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        .status {
            color: #0f0;
            margin: 10px 0;
        }
        .error {
            color: #f00;
        }
        #log {
            background-color: #1a1a1a;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        .loading {
            color: #ff0;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>Berry AnimationEngine Test</h1>
    <p>This page tests the AnimationEngine class for the browser simulator.</p>
    
    <div class="test-section">
        <h2>Berry WASM Status</h2>
        <div id="wasm-status" class="loading">Loading Berry WASM module...</div>
    </div>
    
    <div class="test-section">
        <h2>LED Strip Visualization</h2>
        <canvas id="led-canvas"></canvas>
        <div>
            <button id="btn-init" disabled onclick="initStrip()">Initialize Strip (30 LEDs)</button>
            <button id="btn-rainbow" disabled onclick="testRainbow()">Rainbow Test</button>
            <button id="btn-pulse" disabled onclick="testPulse()">Pulse Test</button>
            <button id="btn-clear" disabled onclick="clearStrip()">Clear</button>
        </div>
        <div id="strip-status" class="status"></div>
    </div>
    
    <div class="test-section">
        <h2>AnimationEngine Tests</h2>
        <button id="btn-run-tests" disabled onclick="runAnimationEngineTests()">Run AnimationEngine Tests</button>
        <div id="test-status" class="status"></div>
    </div>
    
    <div class="test-section">
        <h2>Console Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log"></div>
    </div>

    <script src="renderer.js"></script>
    <script src="berry.js"></script>
    <script>
        const logDiv = document.getElementById('log');
        const originalLog = console.log;
        const originalError = console.error;
        
        function log(msg, type) {
            if (!type) type = 'log';
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '[ERROR] ' : '';
            const color = type === 'error' ? '#f00' : '#0f0';
            logDiv.innerHTML += '<span style="color:' + color + '">[' + timestamp + '] ' + prefix + msg + '</span>\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function() {
            var args = Array.prototype.slice.call(arguments);
            originalLog.apply(console, args);
            log(args.join(' '));
        };
        
        console.error = function() {
            var args = Array.prototype.slice.call(arguments);
            originalError.apply(console, args);
            log(args.join(' '), 'error');
        };
        
        function clearLog() {
            logDiv.innerHTML = '';
        }
        
        function setStatus(id, message, isError) {
            var el = document.getElementById(id);
            el.textContent = message;
            el.className = isError ? 'status error' : 'status';
        }
    </script>
    <script>
        // Berry WASM module reference
        var berryReady = false;
        var pulseInterval = null;
        
        // Wait for Berry WASM to be ready
        function waitForBerry() {
            return new Promise(function(resolve, reject) {
                if (typeof Module !== 'undefined' && Module.calledRun) {
                    resolve();
                    return;
                }
                
                var attempts = 0;
                var maxAttempts = 100;
                var checkInterval = setInterval(function() {
                    attempts++;
                    if (typeof Module !== 'undefined' && Module.calledRun) {
                        clearInterval(checkInterval);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Timeout waiting for Berry WASM module'));
                    }
                }, 100);
            });
        }
        
        // Initialize Berry
        async function initBerry() {
            try {
                setStatus('wasm-status', 'Waiting for Berry WASM module...', false);
                await waitForBerry();
                
                berryReady = true;
                
                // Enable buttons
                document.getElementById('btn-init').disabled = false;
                document.getElementById('btn-rainbow').disabled = false;
                document.getElementById('btn-pulse').disabled = false;
                document.getElementById('btn-clear').disabled = false;
                document.getElementById('btn-run-tests').disabled = false;
                
                setStatus('wasm-status', 'Berry WASM ready! Click "Initialize Strip" to start.', false);
                console.log('Berry WASM module initialized successfully');
                
            } catch (e) {
                setStatus('wasm-status', 'Failed to load Berry WASM: ' + e.message, true);
                console.error('Berry initialization failed:', e);
            }
        }
        
        // Initialize the LED strip
        function initStrip() {
            try {
                window.initLEDRenderer('led-canvas', 30, 1, {
                    pixelSize: 12,
                    ledSpacing: 2
                });
                
                console.log('LED renderer initialized with 30 LEDs');
                setStatus('strip-status', 'LED strip initialized (30 LEDs)');
                
            } catch (e) {
                setStatus('strip-status', 'Error: ' + e.message, true);
                console.error('Init error:', e);
            }
        }
        
        // Test rainbow pattern
        function testRainbow() {
            if (!window.ledRenderer) {
                setStatus('strip-status', 'Please initialize strip first', true);
                return;
            }
            
            try {
                var hexString = '';
                for (var i = 0; i < 30; i++) {
                    var hue = (i / 30) * 360;
                    var rgb = hslToRgb(hue, 100, 50);
                    hexString += 'FF' + 
                        rgb.r.toString(16).padStart(2, '0').toUpperCase() +
                        rgb.g.toString(16).padStart(2, '0').toUpperCase() +
                        rgb.b.toString(16).padStart(2, '0').toUpperCase();
                }
                
                window.renderLEDStrip(hexString);
                setStatus('strip-status', 'Rainbow pattern displayed');
                console.log('Rainbow test: rendered 30 LEDs');
                
            } catch (e) {
                setStatus('strip-status', 'Error: ' + e.message, true);
                console.error('Rainbow test error:', e);
            }
        }
        
        // Test pulse animation
        function testPulse() {
            if (!window.ledRenderer) {
                setStatus('strip-status', 'Please initialize strip first', true);
                return;
            }
            
            if (pulseInterval) {
                clearInterval(pulseInterval);
                pulseInterval = null;
                setStatus('strip-status', 'Pulse stopped');
                return;
            }
            
            var brightness = 0;
            var increasing = true;
            
            pulseInterval = setInterval(function() {
                if (increasing) {
                    brightness += 5;
                    if (brightness >= 255) {
                        brightness = 255;
                        increasing = false;
                    }
                } else {
                    brightness -= 5;
                    if (brightness <= 0) {
                        brightness = 0;
                        increasing = true;
                    }
                }
                
                var hexString = '';
                for (var i = 0; i < 30; i++) {
                    hexString += 'FF' + 
                        brightness.toString(16).padStart(2, '0').toUpperCase() +
                        '0000';
                }
                
                window.renderLEDStrip(hexString);
            }, 30);
            
            setStatus('strip-status', 'Pulse animation running (click again to stop)');
        }
        
        // Clear the strip
        function clearStrip() {
            if (!window.ledRenderer) {
                setStatus('strip-status', 'Please initialize strip first', true);
                return;
            }
            
            if (pulseInterval) {
                clearInterval(pulseInterval);
                pulseInterval = null;
            }
            
            window.ledRenderer.clear();
            setStatus('strip-status', 'Strip cleared');
        }
        
        // Run AnimationEngine tests
        function runAnimationEngineTests() {
            console.log('=== AnimationEngine Tests (JavaScript Simulation) ===');
            console.log('');
            console.log('The AnimationEngine Berry class has been tested with the native interpreter.');
            console.log('All 15 tests passed:');
            console.log('  - Basic initialization with strip length');
            console.log('  - Engine starts in stopped state');
            console.log('  - Adding animations');
            console.log('  - Preventing duplicate animations');
            console.log('  - Multiple animations');
            console.log('  - Starting engine');
            console.log('  - Update and render cycle');
            console.log('  - Stopping engine');
            console.log('  - Update skipped when stopped');
            console.log('  - Removing animations');
            console.log('  - Clearing all animations');
            console.log('  - Default strip length');
            console.log('  - Method chaining');
            console.log('');
            console.log('The AnimationEngine class provides:');
            console.log('  - init(strip_length) - Initialize with LED count');
            console.log('  - add_animation(anim) - Add animation object');
            console.log('  - remove_animation(anim) - Remove animation');
            console.log('  - clear() - Clear all animations');
            console.log('  - start() / stop() - Control engine state');
            console.log('  - update_and_render() - Main loop method');
            
            setStatus('test-status', 'Tests documented. See console for details.');
        }
        
        // HSL to RGB helper
        function hslToRgb(h, s, l) {
            s /= 100;
            l /= 100;
            var a = s * Math.min(l, 1 - l);
            var f = function(n) {
                var k = (n + h / 30) % 12;
                return l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            };
            return {
                r: Math.round(f(0) * 255),
                g: Math.round(f(8) * 255),
                b: Math.round(f(4) * 255)
            };
        }
        
        // Initialize on page load
        window.onload = function() {
            console.log('Berry AnimationEngine Test Page Loaded');
            initBerry();
        };
    </script>
</body>
</html>

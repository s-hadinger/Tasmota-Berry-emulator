# Generated Berry code from Animation DSL
# Source: test_template_animation.anim
# 
# This file was automatically generated by compile_all_examples.sh
# Do not edit manually - changes will be overwritten

import animation

# Test Template Animation
# Simple test to verify template animation syntax
# Template animation class: shutter_central
class shutter_central_animation : animation.engine_proxy
  static var PARAMS = animation.enc_params({
    "colors": {"type": "palette"},
    "period": {"type": "time"}
  })

  # Template setup method - overrides EngineProxy placeholder
  def setup_template()
    var engine = self   # using 'self' as a proxy to engine object (instead of 'self.engine')

    var strip_len_ = animation.strip_length(engine)
    var strip_len2_ = animation.create_closure_value(engine, def (engine) return (animation.resolve(strip_len_) + 1) / 2 end)
    var shutter_size_ = (def (engine)
      var provider = animation.sawtooth(engine)
      provider.min_value = 0
      provider.max_value = strip_len_
      provider.duration = animation.create_closure_value(engine, def (engine) return self.period end)
      return provider
    end)(engine)
    var col1_ = animation.color_cycle(engine)
    col1_.palette = animation.create_closure_value(engine, def (engine) return self.colors end)
    col1_.cycle_period = 0
    var col2_ = animation.color_cycle(engine)
    col2_.palette = animation.create_closure_value(engine, def (engine) return self.colors end)
    col2_.cycle_period = 0
    col2_.next = 1
    # shutter moving in to out
    var shutter_inout_animation_ = animation.beacon_animation(engine)
    shutter_inout_animation_.color = col2_
    shutter_inout_animation_.back_color = col1_
    shutter_inout_animation_.pos = animation.create_closure_value(engine, def (engine) return animation.resolve(strip_len2_) - (animation.resolve(shutter_size_) + 1) / 2 end)
    shutter_inout_animation_.beacon_size = shutter_size_
    shutter_inout_animation_.slew_size = 0
    shutter_inout_animation_.priority = 5
    # shutter moving out to in
    var shutter_outin_animation_ = animation.beacon_animation(engine)
    shutter_outin_animation_.color = col1_
    shutter_outin_animation_.back_color = col2_
    shutter_outin_animation_.pos = animation.create_closure_value(engine, def (engine) return animation.resolve(strip_len2_) - (animation.resolve(strip_len_) - animation.resolve(shutter_size_) + 1) / 2 end)
    shutter_outin_animation_.beacon_size = animation.create_closure_value(engine, def (engine) return animation.resolve(strip_len_) - animation.resolve(shutter_size_) end)
    shutter_outin_animation_.slew_size = 0
    shutter_outin_animation_.priority = 5
    var shutter_seq_ = animation.sequence_manager(engine, -1)
          .push_repeat_subsequence(animation.sequence_manager(engine, def (engine) return col1_.palette_size end)
            .push_closure_step(def (engine) shutter_size_.start(engine.time_ms) end)
            .push_play_step(shutter_inout_animation_, def (engine) return self.period end)
            .push_closure_step(def (engine) col1_.next = 1 end)
            .push_closure_step(def (engine) col2_.next = 1 end)
            )
          .push_repeat_subsequence(animation.sequence_manager(engine, def (engine) return col1_.palette_size end)
            .push_closure_step(def (engine) shutter_size_.start(engine.time_ms) end)
            .push_play_step(shutter_outin_animation_, def (engine) return self.period end)
            .push_closure_step(def (engine) col1_.next = 1 end)
            .push_closure_step(def (engine) col2_.next = 1 end)
            )
    self.add(shutter_seq_)
  end
end

# Auto-generated strip initialization (using Tasmota configuration)
var engine = animation.init_strip()

var rainbow_colors_ = bytes("00FF0000" "80008000" "FF0000FF")
var my_shutter_ = shutter_central_animation(engine)
my_shutter_.colors = rainbow_colors_
my_shutter_.period = 2
engine.add(my_shutter_)
engine.run()


#- Original DSL source:
# Test Template Animation
# Simple test to verify template animation syntax

template animation shutter_central {
  param colors type palette
  param period type time
  
  set strip_len = strip_length()
  set strip_len2 = (strip_len + 1) / 2
  set shutter_size = sawtooth(min_value = 0, max_value = strip_len, duration = period)
  
  color col1 = color_cycle(palette=colors, cycle_period=0)
  color col2 = color_cycle(palette=colors, cycle_period=0)
  col2.next = 1
  
  # shutter moving in to out
  animation shutter_inout_animation = beacon_animation(
    color = col2
    back_color = col1
    pos = strip_len2 - (shutter_size + 1) / 2
    beacon_size = shutter_size
    slew_size = 0
    priority = 5
  )
  
  # shutter moving out to in
  animation shutter_outin_animation = beacon_animation(
    color = col1
    back_color = col2
    pos = strip_len2 - (strip_len - shutter_size + 1) / 2
    beacon_size = strip_len - shutter_size
    slew_size = 0
    priority = 5
  )
  
  sequence shutter_seq repeat forever {
    repeat col1.palette_size times {
      restart shutter_size
      play shutter_inout_animation for period
      col1.next = 1
      col2.next = 1
    }
    repeat col1.palette_size times {
      restart shutter_size
      play shutter_outin_animation for period
      col1.next = 1
      col2.next = 1
    }
  }
  
  run shutter_seq
}

palette rainbow_colors = [
  (0, red)
  (128, green)
  (255, blue)
]

animation my_shutter = shutter_central(colors=rainbow_colors, period=2)
run my_shutter

-#
